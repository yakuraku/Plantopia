name: Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to GCP VM
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.GCP_VM_IP }}
        username: ${{ secrets.GCP_VM_USER }}
        key: ${{ secrets.GCP_SSH_KEY }}
        command_timeout: 10m
        script: |
          set -e  # Exit immediately if any command fails

          echo "Starting deployment to GCP..."

          # Check if project directory exists
          if [ ! -d "/opt/plantopia/Plantopia" ]; then
            echo "Project directory /opt/plantopia/Plantopia not found"
            exit 1
          fi

          cd /opt/plantopia/Plantopia
          echo "Current directory: $(pwd)"

          # Fix potential Git reference issues
          echo "Fetching latest code..."
          git fetch --prune origin
          git reset --hard origin/main

          echo "Activating Python environment..."
          source venv/bin/activate

          echo "Installing dependencies..."
          pip install -r requirements.txt

          echo "Restarting application..."
          sudo supervisorctl restart plantopia

          # Wait for service to start
          echo "Waiting for service to start..."
          sleep 10

          # Check service status
          echo "Checking service health..."
          if sudo supervisorctl status plantopia | grep -q RUNNING; then
            echo "Process is running, checking API response..."

            # Check if API is responding
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:8000/api/v1/ | grep -q "200"; then
              echo "API is responding successfully!"
            else
              echo "Process is running but API is not responding properly"
              echo "Application logs (last 100 lines):"
              sudo supervisorctl tail -100 plantopia
              exit 1
            fi
          else
            echo "Application failed to start"
            echo "Application logs (last 100 lines):"
            sudo supervisorctl tail -100 plantopia
            exit 1
          fi

          # Deployment summary
          echo ""
          echo "âœ… Deployment completed successfully!"
          echo "Deployment Information:"
          echo "  - Server: ${{ secrets.GCP_VM_IP }}"
          echo "  - Project: /opt/plantopia/Plantopia"
          echo "  - Time: $(date)"
          echo "  - Commit: $(git rev-parse --short HEAD)"
          echo "  - Branch: $(git branch --show-current)"